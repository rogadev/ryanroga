---
const generatedResume = 'generatedResume'
---

<script is:inline src='https://cdn.jsdelivr.net/npm/marked/marked.min.js'
></script>

<section id='resume' class='py-20 bg-gray-50 dark:bg-gray-900'>
  <div class='container mx-auto px-4'>
    <h2
      class='text-4xl font-bold text-gray-900 dark:text-white mb-8 text-center'
    >
      Interactive Resume Experience
    </h2>

    <div class='grid md:grid-cols-2 gap-8 max-w-4xl mx-auto mb-12'>
      <a
        href='/RyanRoga_Resume.pdf'
        target='_blank'
        rel='noopener noreferrer'
        class='block'
      >
        <div
          class='bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow'
        >
          <h3 class='text-2xl font-semibold text-gray-900 dark:text-white mb-4'>
            Traditional Resume
          </h3>
          <p class='text-gray-600 dark:text-gray-300'>
            View my standard resume in a traditional format, highlighting my
            experience, skills, and achievements.
          </p>
        </div>
      </a>

      <button id='aiResumeBtn' class='block text-left cursor-pointer'>
        <div
          class='bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow relative'
        >
          <h3 class='text-2xl font-semibold text-gray-900 dark:text-white mb-4'>
            AI-Tailored Resume
          </h3>
          <p class='text-gray-600 dark:text-gray-300'>
            Upload a job posting to receive a customized resume that highlights
            my most relevant experience for the role.
          </p>
          <span
            class='absolute top-0 right-0 mt-2 mr-2 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full'
          >
            NEW
          </span>
        </div>
      </button>
    </div>

    <div id='aiResumeSection' class='hidden max-w-4xl mx-auto'>
      <div class='bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-8'>
        <h3 class='text-2xl font-semibold text-gray-900 dark:text-white mb-6'>
          Generate Tailored Resume
        </h3>
        <form id='jobPostingForm' class='space-y-6'>
          <div>
            <label
              for='jobPosting'
              class='block text-gray-700 dark:text-gray-300 mb-2'
            >
              Job Posting Description
            </label>
            <textarea
              id='jobPosting'
              name='jobPosting'
              rows='6'
              class='w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-colors disabled:opacity-50'
              placeholder='Paste the job posting here...'
              required></textarea>
          </div>
          <button
            type='submit'
            class='w-full md:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center gap-2'
          >
            <span>Generate Resume</span>
            <div class='hidden' id='loadingSpinner'>
              <div
                class='animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full'
              >
              </div>
            </div>
          </button>
        </form>

        <div
          id='terminalOutput'
          class='hidden mt-6 bg-gray-900 rounded-lg overflow-hidden'
        >
          <div class='flex items-center px-4 py-2 bg-gray-800'>
            <div class='flex space-x-2'>
              <button
                class='w-3 h-3 bg-red-500 rounded-full hover:opacity-75'
                id='closeTerminal'></button>
              <button
                class='w-3 h-3 bg-yellow-500 rounded-full hover:opacity-75'
                id='minimizeTerminal'></button>
              <button
                class='w-3 h-3 bg-green-500 rounded-full hover:opacity-75'
                id='maximizeTerminal'></button>
            </div>
          </div>
          <div
            class='p-4 font-mono text-sm text-green-400 space-y-2'
            id='terminalContent'
          >
          </div>
        </div>
      </div>

      <div
        id={generatedResume}
        class='mt-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 markdown-content dark:prose-invert max-w-none overflow-y-auto hidden'
        style='max-height: 40vh;'
      >
      </div>
    </div>

    <div id='resultActions' class='mt-4 text-right hidden'>
      <button
        id='downloadBtn'
        class='px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-lg mx-auto'
      >
        Download Resume
      </button>
    </div>
  </div>

  <style>
    .markdown-content {
      line-height: 1.8;
      @apply prose prose-lg dark:prose-invert max-w-none;

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        font-weight: 700;
        line-height: 1.25;
        color: #f3f4f6;
      }

      h1 {
        font-size: 2em;
      }
      h2 {
        font-size: 1.5em;
      }
      h3 {
        font-size: 1.25em;
      }

      p {
        margin-bottom: 1.25em;
      }

      ul,
      ol {
        padding-left: 1.5em;
        margin-bottom: 1.25em;
      }

      li {
        margin-bottom: 0.5em;
        color: #e5e7eb;
      }

      a {
        color: #60a5fa;
        text-decoration: none;
        transition: color 0.2s;
      }

      a:hover {
        color: #93c5fd;
        text-decoration: underline;
      }

      blockquote {
        padding: 0.75em 1.25em;
        margin: 1.5em 0;
        border-left: 4px solid #4b5563;
        background-color: #374151;
        color: #d1d5db;
      }

      code {
        background-color: #1f2937;
        color: #e5e7eb;
        padding: 0.2em 0.4em;
        border-radius: 0.25em;
      }

      ul li::marker {
        color: #60a5fa;
      }

      hr {
        border-color: #4b5563;
      }
    }

    /* Update synthwave terminal styles with blue theme */
    #terminalContent {
      text-shadow:
        0 0 5px #3b82f6,
        0 0 10px #3b82f6,
        0 0 15px #3b82f6;
      animation: glow 1s ease-in-out infinite alternate;
    }

    #terminalContent div {
      margin-bottom: 0.5em;
      transition: all 0.3s ease;
    }

    /* Different colors for different message types */
    #terminalContent div:has(span.error) {
      color: #ef4444;
      text-shadow:
        0 0 5px #ef4444,
        0 0 10px #ef4444;
    }

    #terminalContent div:has(span.success) {
      color: #22c55e;
      text-shadow:
        0 0 5px #22c55e,
        0 0 10px #22c55e;
    }

    #terminalContent div:has(span.info) {
      color: #60a5fa;
      text-shadow:
        0 0 5px #60a5fa,
        0 0 10px #60a5fa;
    }

    @keyframes glow {
      from {
        text-shadow:
          0 0 5px #3b82f6,
          0 0 10px #3b82f6;
      }
      to {
        text-shadow:
          0 0 7px #3b82f6,
          0 0 14px #3b82f6;
      }
    }

    /* Terminal window styling with reduced glow */
    #terminalOutput {
      background: linear-gradient(45deg, #1a1a1a, #1e293b);
      border: 1px solid #3b82f6;
      box-shadow:
        0 0 5px #3b82f6,
        inset 0 0 5px #3b82f6;
    }

    /* Terminal header styling */
    #terminalOutput > div:first-child {
      background: linear-gradient(90deg, #1e293b, #1a1a1a);
      border-bottom: 1px solid #3b82f6;
    }

    /* Terminal buttons glow effect */
    #terminalOutput button {
      transition: all 0.3s ease;
    }

    #terminalOutput button:hover {
      box-shadow: 0 0 5px currentColor;
    }
  </style>

  <script>
    declare const marked: {
      parse: (
        text: string,
        options?: {
          gfm: boolean
          breaks: boolean
        }
      ) => string
    }

    const generatedResumeElement = document.getElementById('generatedResume')
    const aiResumeBtn = document.getElementById('aiResumeBtn')
    const aiResumeSection = document.getElementById('aiResumeSection')
    let animationInterval: ReturnType<typeof setInterval> | undefined

    if (aiResumeBtn && aiResumeSection) {
      aiResumeBtn.addEventListener('click', () => {
        aiResumeSection.classList.remove('hidden')
        aiResumeSection.scrollIntoView({ behavior: 'smooth' })
      })
    }

    const jobPostingForm = document.getElementById(
      'jobPostingForm'
    ) as HTMLFormElement
    const jobPostingTextarea = document.getElementById(
      'jobPosting'
    ) as HTMLTextAreaElement
    const loadingSpinner = document.getElementById('loadingSpinner')
    const terminalOutput = document.getElementById('terminalOutput')
    const terminalContent = document.getElementById('terminalContent')
    const closeTerminal = document.getElementById('closeTerminal')
    const resultActions = document.getElementById('resultActions')
    const downloadBtn = document.getElementById('downloadBtn')
    const minimizeTerminal = document.getElementById('minimizeTerminal')

    let generatedContent = ''
    let accumulatedContent = ''
    let dotCount = 0

    const addTerminalMessage = (
      message: string,
      type: 'info' | 'success' | 'error' = 'info'
    ) => {
      if (terminalContent) {
        const line = document.createElement('div')
        line.innerHTML = `<span class="${type}">></span> ${message}`
        terminalContent.appendChild(line)
        line.scrollIntoView({ behavior: 'smooth' })
      }
    }

    const updateGeneratingMessage = () => {
      if (terminalContent) {
        const lastLine = terminalContent.lastElementChild
        if (lastLine?.textContent?.startsWith('> Generating')) {
          lastLine.textContent = `> Generating${'.'.repeat(dotCount)}`
          lastLine.scrollIntoView({ behavior: 'smooth' })
        } else {
          const line = document.createElement('div')
          line.textContent = `> Generating${'.'.repeat(dotCount)}`
          terminalContent.appendChild(line)
          line.scrollIntoView({ behavior: 'smooth' })
        }
        dotCount = (dotCount + 1) % 4
      }
    }

    if (closeTerminal) {
      closeTerminal.addEventListener('click', () => {
        if (terminalOutput) {
          terminalOutput.classList.add('hidden')
          if (terminalContent) {
            terminalContent.innerHTML = ''
          }
        }
      })
    }

    if (jobPostingForm) {
      jobPostingForm.addEventListener('submit', async (e) => {
        e.preventDefault()

        // Reset UI state
        if (terminalContent) terminalContent.innerHTML = ''
        if (terminalOutput) terminalOutput.classList.remove('hidden')
        if (resultActions) resultActions.classList.add('hidden')
        if (generatedResumeElement) {
          generatedResumeElement.innerHTML = ''
          generatedResumeElement.classList.add('hidden')
        }

        try {
          // Step 1: Validate job description
          addTerminalMessage('Validating job description...', 'info')
          const validateResponse = await fetch(
            '/api/validate-job-description',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ jobPosting: jobPostingTextarea.value }),
            }
          )

          if (!validateResponse.ok) {
            const error = await validateResponse.json()
            addTerminalMessage('Validation Failed', 'error')
            addTerminalMessage(`Error: ${error.message}`, 'error')
            addTerminalMessage(
              "Please ensure you've provided a complete job posting.",
              'error'
            )
            return
          }

          // Step 2: Analyze job requirements
          addTerminalMessage('Job posting validated', 'success')
          addTerminalMessage('Analyzing job requirements...', 'info')

          const analyzeResponse = await fetch('/api/analyze-job-requirements', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jobPosting: jobPostingTextarea.value }),
          })

          if (!analyzeResponse.ok) {
            const error = await analyzeResponse.json()
            addTerminalMessage('Analysis Failed', 'error')
            addTerminalMessage(`Error: ${error.message}`, 'error')
            addTerminalMessage(
              'Unable to process job requirements. Please try again.',
              'error'
            )
            return
          }

          const { simplifiedDescription } = await analyzeResponse.json()
          addTerminalMessage('Requirements analysis complete', 'success')

          // Step 3: Check conflicts
          addTerminalMessage('Checking compatibility...', 'info')
          const conflictResponse = await fetch('/api/check-conflicts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ simplifiedDescription }),
          })

          if (!conflictResponse.ok) {
            const error = await conflictResponse.json()
            addTerminalMessage('Compatibility Check Failed', 'error')
            addTerminalMessage(`Note: ${error.message}`, 'error')
            addTerminalMessage(
              'Process stopped due to compatibility issues.',
              'error'
            )
            return
          }

          // Step 4: Generate resume
          addTerminalMessage('Compatibility check passed', 'success')
          addTerminalMessage('Starting resume generation...', 'info')

          if (generatedResumeElement) {
            generatedResumeElement.classList.remove('hidden')
          }

          animationInterval = setInterval(updateGeneratingMessage, 500)

          const response = await fetch('/api/generate-resume', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jobPosting: jobPostingTextarea.value }),
          })

          if (!response.ok) {
            const errorData = await response.json()
            clearInterval(animationInterval)

            if (
              terminalContent?.lastElementChild?.textContent?.startsWith(
                '> Generating'
              )
            ) {
              terminalContent.removeChild(terminalContent.lastElementChild)
            }

            addTerminalMessage('Resume Generation Failed', 'error')

            if (errorData.error?.type === 'overloaded_error') {
              addTerminalMessage('AI service is currently overloaded.', 'error')
              addTerminalMessage(
                'Would you like to try using OpenAI instead?',
                'error'
              )

              const retryDiv = document.createElement('div')
              retryDiv.className = 'mt-4 flex gap-4'
              retryDiv.innerHTML = `
                <button id="retryWithOpenAI" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-300">
                  Try with OpenAI
                </button>
                <button id="cancelGeneration" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-300">
                  Cancel
                </button>
              `
              terminalContent?.appendChild(retryDiv)
              return
            }

            addTerminalMessage(
              `Error: ${errorData.error?.message || 'Unknown error occurred'}`,
              'error'
            )
            addTerminalMessage('Please try again later.', 'error')
            return
          }

          const reader = response.body?.getReader()
          const decoder = new TextDecoder()

          if (reader) {
            while (true) {
              const { done, value } = await reader.read()
              if (done) break

              const chunk = decoder.decode(value)
              accumulatedContent += chunk

              if (generatedResumeElement) {
                const htmlContent = marked.parse(accumulatedContent, {
                  gfm: true,
                  breaks: true,
                })
                generatedResumeElement.innerHTML = htmlContent

                const isNearBottom =
                  generatedResumeElement.scrollHeight -
                    generatedResumeElement.scrollTop -
                    generatedResumeElement.clientHeight <
                  100

                if (isNearBottom) {
                  generatedResumeElement.scrollTop =
                    generatedResumeElement.scrollHeight
                }
              }
            }
          }

          clearInterval(animationInterval)
          if (
            terminalContent?.lastElementChild?.textContent?.startsWith(
              '> Generating'
            )
          ) {
            terminalContent.removeChild(terminalContent.lastElementChild)
          }
          addTerminalMessage('Generation complete!', 'success')

          if (resultActions) {
            resultActions.classList.remove('hidden')
            resultActions.classList.add('flex')
          }

          generatedContent = accumulatedContent
        } catch (error) {
          if (animationInterval) {
            clearInterval(animationInterval)
          }

          if (
            terminalContent?.lastElementChild?.textContent?.startsWith(
              '> Generating'
            )
          ) {
            terminalContent.removeChild(terminalContent.lastElementChild)
          }

          addTerminalMessage('Process Failed', 'error')
          addTerminalMessage(
            `An unexpected error occurred: ${error instanceof Error ? error.message : 'Unknown error'}`,
            'error'
          )
          addTerminalMessage(
            'Please try again. If the problem persists, contact support.',
            'error'
          )

          if (generatedResumeElement) {
            generatedResumeElement.classList.add('hidden')
          }
        } finally {
          jobPostingTextarea.disabled = false
          document.body.style.cursor = 'default'
          if (loadingSpinner) loadingSpinner.classList.add('hidden')
        }
      })
    }

    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        const cleanContent = generatedContent
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<div[^>]*>(.*?)<\/div>/g, '$1')
          .replace(/<\/?[^>]+(>|$)/g, '')
          .replace(/\n\s*\n\s*\n/g, '\n\n')
          .trim()

        const blob = new Blob([cleanContent], { type: 'text/markdown' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'tailored-resume.md'
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      })
    }

    if (minimizeTerminal && terminalContent) {
      minimizeTerminal.addEventListener('click', () => {
        terminalContent.classList.toggle('hidden')
      })
    }

    const maximizeTerminal = document.getElementById('maximizeTerminal')
    const terminalContainer = document.getElementById('terminalOutput')

    if (maximizeTerminal && terminalContainer) {
      maximizeTerminal.addEventListener('click', () => {
        terminalContainer.classList.toggle('fixed')
        terminalContainer.classList.toggle('inset-4')
        terminalContainer.classList.toggle('z-50')
        terminalContainer.classList.toggle('m-4')
      })
    }
  </script>
</section>
